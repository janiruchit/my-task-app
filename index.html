<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>ProTask Ultimate</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --primary: #6366f1; --danger: #ef4444; --success: #22c55e; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 450px; }
        .card { background: var(--card); padding: 25px; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); }
        h2 { margin: 0 0 20px 0; color: var(--primary); text-align: center; }
        input { width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; border: 1px solid #334155; background: #0f172a; color: white; font-size: 16px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        .btn-add { background: var(--primary); color: white; }
        .btn-stop { background: var(--danger); color: white; display: none; }
        .btn-snooze { background: var(--success); color: white; display: none; }
        .task-item { background: #334155; padding: 15px; border-radius: 16px; margin-top: 15px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid var(--primary); }
        #overlay { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        .ringing { border-left-color: var(--danger); animation: pulse 0.8s infinite alternate; }
        @keyframes pulse { from { box-shadow: 0 0 5px var(--danger); } to { box-shadow: 0 0 20px var(--danger); } }
    </style>
</head>
<body>

<div id="overlay">
    <h2>System Standby</h2>
    <p>Tap to unlock high-priority audio & background alerts.</p>
    <button class="btn-add" style="width:220px" onclick="startApp()">ACTIVATE APP</button>
</div>

<div class="container">
    <div class="card">
        <h2>ProTask Pro</h2>
        <input type="text" id="name" placeholder="Task Name">
        <input type="datetime-local" id="time">
        <button class="btn-add" onclick="addTask()">Set Reminder</button>
        
        <button id="stopBtn" class="btn-stop" onclick="stopAlarm()">STOP ALARM</button>
        <button id="snoozeBtn" class="btn-snooze" onclick="snoozeAlarm()">SNOOZE (5 MIN)</button>
    </div>
    <div id="taskList"></div>
</div>

<audio id="siren" loop playsinline>
    <source src="https://actions.google.com/sounds/v1/alarms/emergency_it_is_happening.ogg" type="audio/ogg">
    <source src="https://noproblo.dayjo.org/ZeldaSounds/OOT/OOT_Navi_Listen1.wav" type="audio/wav">
</audio>

<script>
    let tasks = JSON.parse(localStorage.getItem('pro_tasks')) || [];
    const siren = document.getElementById('siren');
    let currentRingingTask = null;

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }

    async function startApp() {
        // Prime audio engine for mobile
        siren.play().then(() => { siren.pause(); siren.currentTime = 0; });
        if ("Notification" in window) await Notification.requestPermission();
        document.getElementById('overlay').style.display = 'none';
        render();
    }

    function addTask() {
        const name = document.getElementById('name').value;
        const timeInput = document.getElementById('time').value;
        if (!name || !timeInput) return alert("Fill all fields");

        const task = { id: Date.now(), name, time: new Date(timeInput).getTime(), alerted: false };
        tasks.push(task);
        saveAndRender();
        document.getElementById('name').value = '';
    }

    setInterval(() => {
        const now = Date.now();
        tasks.forEach(t => {
            if (t.time <= now && !t.alerted) {
                triggerAlarm(t);
            }
        });
    }, 1000);

    function triggerAlarm(task) {
        task.alerted = true;
        currentRingingTask = task;
        
        // Sound & Vibration
        siren.play().catch(() => console.log("User interaction required for sound"));
        if (navigator.vibrate) navigator.vibrate([500, 300, 500, 300, 500]);

        // UI Updates
        document.getElementById('stopBtn').style.display = 'block';
        document.getElementById('snoozeBtn').style.display = 'block';

        // Background Notification
        if (Notification.permission === "granted") {
            navigator.serviceWorker.ready.then(reg => {
                reg.showNotification("⏰ TASK DUE!", {
                    body: task.name,
                    icon: "https://cdn-icons-png.flaticon.com/512/1827/1827347.png",
                    requireInteraction: true,
                    vibrate: [200, 100, 200]
                });
            });
        }
        render();
    }

    function stopAlarm() {
        siren.pause();
        siren.currentTime = 0;
        document.getElementById('stopBtn').style.display = 'none';
        document.getElementById('snoozeBtn').style.display = 'none';
        currentRingingTask = null;
        render();
    }

    function snoozeAlarm() {
        if (!currentRingingTask) return;
        
        // Set new time for 5 minutes later
        const snoozeTime = Date.now() + (5 * 60 * 1000);
        currentRingingTask.time = snoozeTime;
        currentRingingTask.alerted = false;
        
        stopAlarm();
        saveAndRender();
        alert("Snoozed for 5 minutes!");
    }

    function deleteTask(id) {
        tasks = tasks.filter(t => t.id !== id);
        saveAndRender();
    }

    function saveAndRender() {
        localStorage.setItem('pro_tasks', JSON.stringify(tasks));
        render();
    }

    function render() {
        const list = document.getElementById('taskList');
        list.innerHTML = tasks.map(t => `
            <div class="task-item ${t.alerted && !siren.paused ? 'ringing' : ''}">
                <div>
                    <strong>${t.name}</strong><br>
                    <small>${new Date(t.time).toLocaleString()}</small>
                </div>
                <button onclick="deleteTask(${t.id})" style="width:auto; margin:0; background:none; color:var(--danger); font-size:20px;">✕</button>
            </div>
        `).join('');
    }
</script>
</body>
</html>
